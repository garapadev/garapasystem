# M√≥dulo WhatsApp - API GarapaSystem

## Vis√£o Geral

O m√≥dulo WhatsApp do GarapaSystem oferece uma integra√ß√£o completa com APIs de WhatsApp, permitindo o envio e recebimento de mensagens, gerenciamento de sess√µes e automa√ß√£o de comunica√ß√£o. O sistema suporta m√∫ltiplas APIs (WuzAPI e WAHA) atrav√©s de um padr√£o de adaptadores, oferecendo flexibilidade e escalabilidade.

## Caracter√≠sticas Principais

### üîå M√∫ltiplas APIs Suportadas
- **WuzAPI**: API local para WhatsApp Web
- **WAHA**: WhatsApp HTTP API (Web Application for HTTP API)
- Padr√£o de adaptadores para f√°cil extens√£o

### üì± Gerenciamento de Sess√µes
- Cria√ß√£o e gerenciamento de sess√µes por colaborador
- Autentica√ß√£o via QR Code
- Monitoramento de status em tempo real
- Reconex√£o autom√°tica

### üí¨ Envio de Mensagens
- Mensagens de texto
- Suporte a diferentes tipos de m√≠dia
- Valida√ß√£o de destinat√°rios
- Controle de status de entrega

### üîÑ Proxy Inteligente
- Roteamento autom√°tico entre APIs
- Autentica√ß√£o transparente
- Headers de CORS configurados
- Logs detalhados para debug

### üéØ Webhooks
- Recebimento de mensagens em tempo real
- Eventos de status de sess√£o
- Processamento de QR Codes
- Sistema de eventos extens√≠vel

## Relacionamentos entre Entidades

### Colaborador ‚Üî WhatsApp Token
```
Colaborador {
  id: string
  whatsappToken: string?
  whatsappInstanceName: string?
}
```

### Configura√ß√µes de API
```
Configuracao {
  chave: string
  valor: string
}

// Chaves relacionadas ao WhatsApp:
- whatsapp_api_type: 'wuzapi' | 'waha'
- wuzapi_url: string
- wuzapi_admin_token: string
- waha_url: string
- waha_api_key: string
```

## Endpoints da API

### 1. Rotas Din√¢micas do WhatsApp
**Endpoint:** `/api/whatsapp/[...path]`

#### Listar Status
```http
GET /api/whatsapp/status
```

**Resposta:**
```json
{
  "status": "online",
  "version": "1.0.0",
  "adapter": "wuzapi"
}
```

#### Listar Sess√µes
```http
GET /api/whatsapp/sessions
```

**Resposta:**
```json
{
  "sessions": [
    {
      "id": "session_123",
      "name": "Colaborador 1",
      "status": "working",
      "qr": null
    }
  ]
}
```

#### Criar Sess√£o
```http
POST /api/whatsapp/sessions
Content-Type: application/json

{
  "name": "Nova Sess√£o",
  "token": "session_token_123"
}
```

#### Obter Status da Sess√£o
```http
GET /api/whatsapp/sessions/{sessionId}
```

#### Deletar Sess√£o
```http
DELETE /api/whatsapp/sessions/{sessionId}
```

#### Enviar Mensagem
```http
POST /api/whatsapp/send
Content-Type: application/json
X-Session-Id: session_123

{
  "to": "5511999999999",
  "body": "Ol√°! Esta √© uma mensagem de teste.",
  "type": "text"
}
```

**Resposta:**
```json
{
  "success": true,
  "messageId": "msg_abc123"
}
```

### 2. Proxy WuzAPI
**Endpoint:** `/api/wuzapi/[...path]`

Proxy transparente para a API WuzAPI com:
- Autentica√ß√£o autom√°tica
- Roteamento de endpoints
- Logs detalhados
- Headers CORS

#### Exemplo de Uso
```http
POST /api/wuzapi/session_123/send-message
Content-Type: application/json

{
  "phone": "5511999999999",
  "message": "Mensagem via proxy"
}
```

### 3. Token do WhatsApp para Colaboradores
**Endpoint:** `/api/colaboradores/whatsapp-token`

#### Obter Token
```http
GET /api/colaboradores/whatsapp-token
Authorization: Bearer {session_token}
```

**Resposta:**
```json
{
  "success": true,
  "data": {
    "id": "collab_123",
    "whatsappToken": "token_abc123",
    "whatsappInstanceName": "Inst√¢ncia Principal"
  },
  "authType": "session"
}
```

#### Atualizar Token
```http
PUT /api/colaboradores/whatsapp-token
Authorization: Bearer {session_token}
Content-Type: application/json

{
  "whatsappToken": "novo_token_123",
  "whatsappInstanceName": "Nova Inst√¢ncia"
}
```

### 4. Webhook do WhatsApp
**Endpoint:** `/api/webhooks/whatsapp`

#### Receber Eventos
```http
POST /api/webhooks/whatsapp
Content-Type: application/json

{
  "event": "message",
  "data": {
    "from": "5511999999999",
    "body": "Mensagem recebida",
    "timestamp": 1640995200
  }
}
```

#### Verificar Status
```http
GET /api/webhooks/whatsapp
```

**Resposta:**
```json
{
  "status": "active",
  "endpoint": "/api/webhooks/whatsapp",
  "message": "Webhook WhatsApp est√° ativo"
}
```

## C√≥digos de Status HTTP

| C√≥digo | Descri√ß√£o | Uso |
|--------|-----------|-----|
| 200 | Sucesso | Opera√ß√£o realizada com sucesso |
| 201 | Criado | Sess√£o/usu√°rio criado com sucesso |
| 400 | Requisi√ß√£o Inv√°lida | Dados de entrada inv√°lidos |
| 401 | N√£o Autorizado | Token de autentica√ß√£o inv√°lido |
| 403 | Proibido | Permiss√µes insuficientes |
| 404 | N√£o Encontrado | Sess√£o/usu√°rio n√£o encontrado |
| 500 | Erro Interno | Erro no servidor ou API externa |

## Valida√ß√µes e Regras de Neg√≥cio

### Autentica√ß√£o
- Todas as rotas requerem autentica√ß√£o v√°lida
- API Keys t√™m permiss√µes espec√≠ficas por endpoint
- Sess√µes de usu√°rio s√£o validadas por email

### Sess√µes
- Uma sess√£o por colaborador
- Token √∫nico por sess√£o
- Status v√°lidos: `starting`, `scan_qr`, `working`, `failed`, `stopped`

### Mensagens
- Destinat√°rio obrigat√≥rio (formato internacional)
- Corpo da mensagem obrigat√≥rio
- Sess√£o deve estar ativa (`working`)

### Configura√ß√µes
- URLs de API devem ser v√°lidas
- Tokens de autentica√ß√£o s√£o obrigat√≥rios
- Tipo de API deve ser `wuzapi` ou `waha`

## Seguran√ßa

### Controle de Acesso
- Autentica√ß√£o por sess√£o ou API Key
- Valida√ß√£o de permiss√µes por endpoint
- Isolamento de dados por colaborador

### Valida√ß√£o de Dados
- Sanitiza√ß√£o de inputs
- Valida√ß√£o de formatos de telefone
- Escape de caracteres especiais

### Logs e Auditoria
- Logs detalhados de requisi√ß√µes
- Rastreamento de erros
- Monitoramento de uso

## Performance e Otimiza√ß√£o

### Cache
- Cache de configura√ß√µes de API
- Reutiliza√ß√£o de adaptadores
- Conex√µes WebSocket persistentes

### Rate Limiting
- Controle de taxa por colaborador
- Throttling de mensagens
- Prote√ß√£o contra spam

### Monitoramento
- Health checks das APIs
- M√©tricas de performance
- Alertas de falhas

## Integra√ß√£o com Outros M√≥dulos

### Colaboradores
- Associa√ß√£o de tokens por colaborador
- Valida√ß√£o de permiss√µes
- Hist√≥rico de atividades

### Notifica√ß√µes
- Eventos de mensagens recebidas
- Alertas de desconex√£o
- Status de entrega

### Configura√ß√µes
- Gerenciamento de APIs ativas
- Configura√ß√µes globais
- Fallbacks autom√°ticos

## Exemplos de Uso

### Inicializar Sess√£o
```javascript
// 1. Configurar token do colaborador
const response = await fetch('/api/colaboradores/whatsapp-token', {
  method: 'PUT',
  headers: {
    'Authorization': 'Bearer ' + sessionToken,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    whatsappToken: 'meu_token_123',
    whatsappInstanceName: 'Atendimento'
  })
});

// 2. Criar sess√£o
const sessionResponse = await fetch('/api/whatsapp/sessions', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    name: 'Sess√£o Atendimento',
    token: 'meu_token_123'
  })
});

// 3. Verificar status (pode retornar QR Code)
const statusResponse = await fetch('/api/whatsapp/sessions/meu_token_123');
const status = await statusResponse.json();

if (status.status === 'scan_qr' && status.qr) {
  // Exibir QR Code para o usu√°rio
  console.log('QR Code:', status.qr);
}
```

### Enviar Mensagem
```javascript
const messageResponse = await fetch('/api/whatsapp/send', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Session-Id': 'meu_token_123'
  },
  body: JSON.stringify({
    to: '5511999999999',
    body: 'Ol√°! Como posso ajud√°-lo hoje?',
    type: 'text'
  })
});

const result = await messageResponse.json();
if (result.success) {
  console.log('Mensagem enviada:', result.messageId);
}
```

### Processar Webhook
```javascript
// No webhook handler
app.post('/api/webhooks/whatsapp', (req, res) => {
  const { event, data } = req.body;
  
  switch (event) {
    case 'message':
      console.log('Nova mensagem:', data);
      // Processar mensagem recebida
      break;
    case 'status':
      console.log('Status atualizado:', data);
      // Atualizar status da sess√£o
      break;
    case 'qr':
      console.log('QR Code gerado:', data);
      // Enviar QR Code para o frontend
      break;
  }
  
  res.json({ success: true });
});
```

## Webhooks e Eventos

### Eventos Suportados
- `message`: Nova mensagem recebida
- `status`: Mudan√ßa de status da sess√£o
- `qr`: QR Code gerado/atualizado
- `session.ready`: Sess√£o conectada
- `session.disconnected`: Sess√£o desconectada

### Configura√ß√£o de Webhooks
```json
{
  "webhooks": [
    {
      "url": "https://meuapp.com/api/webhooks/whatsapp",
      "events": ["message", "session.status"],
      "secret": "webhook_secret_123"
    }
  ]
}
```

## Troubleshooting

### Problemas Comuns

#### Sess√£o n√£o conecta
- Verificar se a API est√° online
- Validar token de autentica√ß√£o
- Verificar configura√ß√µes de rede

#### QR Code n√£o aparece
- Verificar status da sess√£o
- Tentar recriar a sess√£o
- Verificar logs da API

#### Mensagens n√£o s√£o enviadas
- Verificar se a sess√£o est√° ativa
- Validar formato do n√∫mero de telefone
- Verificar rate limits

### Logs Importantes
```bash
# Logs do proxy
WuzAPI Proxy: { targetUrl, apiPath, authMethod }

# Logs de webhook
üì® Webhook WhatsApp recebido: { event, data }

# Logs de erro
‚ùå Erro ao processar webhook WhatsApp: error
```

## Relat√≥rios e M√©tricas

### M√©tricas Dispon√≠veis
- N√∫mero de sess√µes ativas
- Mensagens enviadas/recebidas
- Taxa de sucesso de entrega
- Tempo de resposta das APIs
- Erros por tipo

### Dashboards
- Status das sess√µes por colaborador
- Volume de mensagens por per√≠odo
- Performance das APIs
- Alertas de falhas

## Changelog

### v1.0.0 (Atual)
- ‚úÖ Suporte a WuzAPI e WAHA
- ‚úÖ Gerenciamento de sess√µes
- ‚úÖ Envio de mensagens
- ‚úÖ Sistema de webhooks
- ‚úÖ Proxy transparente
- ‚úÖ Autentica√ß√£o por colaborador

### Pr√≥ximas Vers√µes
- üîÑ Suporte a mensagens de m√≠dia
- üîÑ Chat em tempo real
- üîÑ Automa√ß√£o de respostas
- üîÑ Integra√ß√£o com CRM
- üîÑ Analytics avan√ßados

## Suporte

### Documenta√ß√£o T√©cnica
- C√≥digo fonte: `/app/src/app/api/whatsapp/`
- Adaptadores: `/app/src/lib/whatsapp/adapters/`
- Tipos: `/app/src/lib/whatsapp/types.ts`

### APIs Externas
- [WuzAPI Documentation](https://github.com/wuzapi/wuzapi)
- [WAHA Documentation](https://waha.devlike.pro/)

### Contato
- Email: suporte@garapasystem.com
- Documenta√ß√£o: `/app/docs/`
- Issues: Sistema interno de tickets