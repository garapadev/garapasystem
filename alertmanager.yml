# Configura√ß√£o do Alertmanager para GarapaSystem
global:
  smtp_smarthost: 'smtp.garapasystem.com:587'
  smtp_from: 'alerts@garapasystem.com'
  smtp_auth_username: 'alerts@garapasystem.com'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

# Templates para notifica√ß√µes
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Configura√ß√£o de rotas
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  routes:
    # Alertas cr√≠ticos - notifica√ß√£o imediata
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m

    # Alertas de inst√¢ncias espec√≠ficas
    - match_re:
        alertname: 'InstanceDown|HighErrorRate|DatabaseConnectionFailed'
      receiver: 'instance-alerts'
      group_by: ['company_id', 'instance_id']

    # Alertas de infraestrutura
    - match_re:
        alertname: 'CollectorDown|PrometheusDown|ElasticsearchDown'
      receiver: 'infrastructure-alerts'

    # Alertas de seguran√ßa
    - match_re:
        alertname: 'UnauthorizedAccess|CertificateExpiring|TLSHandshakeFailed'
      receiver: 'security-alerts'

    # Alertas de performance
    - match_re:
        alertname: 'HighLatency|HighMemoryUsage|HighCPUUsage'
      receiver: 'performance-alerts'

# Configura√ß√£o de receivers
receivers:
  - name: 'default'
    email_configs:
      - to: 'admin@garapasystem.com'
        subject: '[GarapaSystem] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Labels: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
          {{ end }}

  - name: 'critical-alerts'
    email_configs:
      - to: 'critical@garapasystem.com'
        subject: '[CR√çTICO] {{ .GroupLabels.alertname }} - {{ .GroupLabels.company_id }}'
        body: |
          üö® ALERTA CR√çTICO üö®
          
          {{ range .Alerts }}
          Empresa: {{ .Labels.company_id }}
          Inst√¢ncia: {{ .Labels.instance_id }}
          Servi√ßo: {{ .Labels.service }}
          
          Problema: {{ .Annotations.summary }}
          Descri√ß√£o: {{ .Annotations.description }}
          
          Hor√°rio: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          Dashboard: https://telemetry.garapasystem.com/grafana/d/instance-overview?var-company={{ .Labels.company_id }}&var-instance={{ .Labels.instance_id }}
          {{ end }}
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-critical'
        title: 'üö® Alerta Cr√≠tico - {{ .GroupLabels.company_id }}'
        text: |
          {{ range .Alerts }}
          *Empresa:* {{ .Labels.company_id }}
          *Inst√¢ncia:* {{ .Labels.instance_id }}
          *Problema:* {{ .Annotations.summary }}
          *Descri√ß√£o:* {{ .Annotations.description }}
          {{ end }}

  - name: 'instance-alerts'
    email_configs:
      - to: 'instances@garapasystem.com'
        subject: '[Inst√¢ncia] {{ .GroupLabels.company_id }} - {{ .GroupLabels.alertname }}'
        body: |
          Alerta de Inst√¢ncia
          
          {{ range .Alerts }}
          Empresa: {{ .Labels.company_id }}
          Inst√¢ncia: {{ .Labels.instance_id }}
          Vers√£o: {{ .Labels.service_version }}
          
          Problema: {{ .Annotations.summary }}
          Descri√ß√£o: {{ .Annotations.description }}
          
          Runbook: {{ .Annotations.runbook_url }}
          Dashboard: https://telemetry.garapasystem.com/grafana/d/instance-overview?var-company={{ .Labels.company_id }}
          {{ end }}

  - name: 'infrastructure-alerts'
    email_configs:
      - to: 'infra@garapasystem.com'
        subject: '[Infraestrutura] {{ .GroupLabels.alertname }}'
        body: |
          Alerta de Infraestrutura
          
          {{ range .Alerts }}
          Componente: {{ .Labels.job }}
          Inst√¢ncia: {{ .Labels.instance }}
          
          Problema: {{ .Annotations.summary }}
          Descri√ß√£o: {{ .Annotations.description }}
          
          A√ß√£o Recomendada: {{ .Annotations.action }}
          {{ end }}
    pagerduty_configs:
      - routing_key: '${PAGERDUTY_ROUTING_KEY}'
        description: '{{ .GroupLabels.alertname }} - {{ .GroupLabels.job }}'

  - name: 'security-alerts'
    email_configs:
      - to: 'security@garapasystem.com'
        subject: '[SEGURAN√áA] {{ .GroupLabels.alertname }}'
        body: |
          üîí ALERTA DE SEGURAN√áA üîí
          
          {{ range .Alerts }}
          Tipo: {{ .Labels.alertname }}
          Origem: {{ .Labels.instance }}
          
          Detalhes: {{ .Annotations.description }}
          
          A√ß√£o Imediata Necess√°ria: {{ .Annotations.action }}
          {{ end }}
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#security-alerts'
        title: 'üîí Alerta de Seguran√ßa'

  - name: 'performance-alerts'
    email_configs:
      - to: 'performance@garapasystem.com'
        subject: '[Performance] {{ .GroupLabels.alertname }} - {{ .GroupLabels.company_id }}'
        body: |
          Alerta de Performance
          
          {{ range .Alerts }}
          Empresa: {{ .Labels.company_id }}
          Servi√ßo: {{ .Labels.service }}
          M√©trica: {{ .Labels.alertname }}
          
          Valor Atual: {{ .Annotations.current_value }}
          Threshold: {{ .Annotations.threshold }}
          
          Recomenda√ß√£o: {{ .Annotations.recommendation }}
          {{ end }}

# Configura√ß√£o de inibi√ß√£o (evitar spam de alertas)
inhibit_rules:
  # Se uma inst√¢ncia est√° down, n√£o alertar sobre m√©tricas espec√≠ficas
  - source_match:
      alertname: 'InstanceDown'
    target_match_re:
      alertname: 'HighLatency|HighErrorRate|DatabaseConnectionFailed'
    equal: ['company_id', 'instance_id']

  # Se o coletor est√° down, n√£o alertar sobre falta de m√©tricas
  - source_match:
      alertname: 'CollectorDown'
    target_match_re:
      alertname: 'MetricsNotReceived|TracesNotReceived'
    equal: ['cluster']

# Configura√ß√£o de silenciamento autom√°tico
mute_time_intervals:
  - name: 'maintenance-window'
    time_intervals:
      - times:
          - start_time: '02:00'
            end_time: '04:00'
        weekdays: ['sunday']
        months: ['1:12']

  - name: 'business-hours'
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '18:00'
        weekdays: ['monday:friday']