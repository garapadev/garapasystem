// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Entidades de Domínio - CRM/ERP

// Usuários do sistema (autenticação)
model Usuario {
  id            String   @id @default(cuid())
  email         String   @unique
  senha         String
  nome          String
  ativo         Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relacionamentos
  colaboradorId String?  @unique
  colaborador   Colaborador? @relation(fields: [colaboradorId], references: [id])
  
  // Histórico de oportunidades
  historicoOportunidades HistoricoOportunidade[]
  
  @@map("usuarios")
}

// Clientes e Leads
model Cliente {
  id             String      @id @default(cuid())
  nome           String
  email          String?     @unique
  telefone       String?
  documento      String?     // CPF/CNPJ
  tipo           TipoCliente @default(PESSOA_FISICA)
  status         StatusCliente @default(LEAD)
  endereco       String?
  cidade         String?
  estado         String?
  cep            String?
  observacoes    String?
  valorPotencial Float?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  // Relacionamentos
  grupoHierarquicoId String?
  grupoHierarquico   GrupoHierarquico? @relation(fields: [grupoHierarquicoId], references: [id])
  
  // Oportunidades
  oportunidades  Oportunidade[]
  
  @@map("clientes")
}

// Grupos Hierárquicos (departamentos, equipes, etc.)
model GrupoHierarquico {
  id          String            @id @default(cuid())
  nome        String
  descricao   String?
  ativo       Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  // Hierarquia
  parentId    String?
  parent      GrupoHierarquico? @relation("GrupoHierarquia", fields: [parentId], references: [id])
  children    GrupoHierarquico[] @relation("GrupoHierarquia")
  
  // Relacionamentos
  clientes    Cliente[]
  colaboradores Colaborador[]
  
  @@map("grupos_hierarquicos")
}

// Permissões do sistema (RBAC)
model Permissao {
  id          String   @id @default(cuid())
  nome        String   @unique
  descricao   String?
  recurso     String   // ex: "clientes", "colaboradores"
  acao        String   // ex: "criar", "ler", "editar", "excluir"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos
  perfis      PerfilPermissao[]
  
  @@map("permissoes")
}

// Perfis de acesso (RBAC)
model Perfil {
  id          String   @id @default(cuid())
  nome        String   @unique
  descricao   String?
  ativo       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos
  permissoes  PerfilPermissao[]
  colaboradores Colaborador[]
  
  @@map("perfis")
}

// Tabela associativa entre Perfil e Permissão
model PerfilPermissao {
  perfilId    String
  permissaoId String
  
  perfil      Perfil   @relation(fields: [perfilId], references: [id], onDelete: Cascade)
  permissao   Permissao @relation(fields: [permissaoId], references: [id], onDelete: Cascade)
  
  @@id([perfilId, permissaoId])
  @@map("perfil_permissao")
}

// Colaboradores/Empregados
model Colaborador {
  id             String   @id @default(cuid())
  nome           String
  email          String   @unique
  telefone       String?
  documento      String?  // CPF
  cargo          String?
  dataAdmissao   DateTime?
  ativo          Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relacionamentos
  usuarios       Usuario[]
  perfilId       String?
  perfil         Perfil?  @relation(fields: [perfilId], references: [id])
  grupoHierarquicoId String?
  grupoHierarquico   GrupoHierarquico? @relation(fields: [grupoHierarquicoId], references: [id])
  
  // Oportunidades como responsável
  oportunidades  Oportunidade[]
  
  @@map("colaboradores")
}

// Pipeline de Negócios
model EtapaPipeline {
  id          String   @id @default(cuid())
  nome        String
  descricao   String?
  ordem       Int      // Ordem das etapas no pipeline
  cor         String?  // Cor para visualização no kanban
  ativo       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos
  oportunidades Oportunidade[]
  
  @@map("etapas_pipeline")
}

model Oportunidade {
  id             String   @id @default(cuid())
  titulo         String
  descricao      String?
  valor          Float?
  probabilidade  Int?     // Percentual de 0 a 100
  dataFechamento DateTime?
  observacoes    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relacionamentos
  clienteId      String
  cliente        Cliente  @relation(fields: [clienteId], references: [id])
  
  responsavelId  String?
  responsavel    Colaborador? @relation(fields: [responsavelId], references: [id])
  
  etapaId        String
  etapa          EtapaPipeline @relation(fields: [etapaId], references: [id])
  
  // Histórico
  historico      HistoricoOportunidade[]
  
  @@map("oportunidades")
}

model HistoricoOportunidade {
  id            String   @id @default(cuid())
  acao          String   // "criada", "etapa_alterada", "valor_alterado", etc.
  valorAnterior String?  // JSON com valores anteriores
  valorNovo     String?  // JSON com valores novos
  observacao    String?
  createdAt     DateTime @default(now())
  
  // Relacionamentos
  oportunidadeId String
  oportunidade   Oportunidade @relation(fields: [oportunidadeId], references: [id], onDelete: Cascade)
  
  usuarioId      String?
  usuario        Usuario? @relation(fields: [usuarioId], references: [id])
  
  @@map("historico_oportunidades")
}

// Enums
enum TipoCliente {
  PESSOA_FISICA
  PESSOA_JURIDICA
}

enum StatusCliente {
  LEAD
  PROSPECT
  CLIENTE
  INATIVO
}