import { PrismaClient } from '@prisma/client'
import bcrypt from 'bcryptjs'

const prisma = new PrismaClient()

async function main() {
  console.log('üå± Iniciando seed do banco de dados...')

  // Verificar se o banco j√° tem usu√°rios
  console.log('üîç Verificando se o banco de dados j√° cont√©m usu√°rios...')
  const userCount = await prisma.usuario.count()
  
  if (userCount > 0) {
    console.log(`üìä Banco j√° cont√©m ${userCount} usu√°rio(s). Pulando seed inicial.`)
    return
  }

  console.log('‚úÖ Banco vazio detectado. Executando seed inicial completo...')

  // Criar permiss√µes completas para todos os m√≥dulos
  console.log('üìã Criando permiss√µes completas...')
  const permissoes = await Promise.all([
    // Dashboard
    prisma.permissao.upsert({
      where: { nome: 'dashboard_ler' },
      update: {},
      create: {
        nome: 'dashboard_ler',
        descricao: 'Visualizar dashboard',
        recurso: 'dashboard',
        acao: 'ler'
      }
    }),
    
    // Clientes - CRUD completo
    prisma.permissao.upsert({
      where: { nome: 'clientes_criar' },
      update: {},
      create: {
        nome: 'clientes_criar',
        descricao: 'Criar clientes',
        recurso: 'clientes',
        acao: 'criar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'clientes_ler' },
      update: {},
      create: {
        nome: 'clientes_ler',
        descricao: 'Visualizar clientes',
        recurso: 'clientes',
        acao: 'ler'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'clientes_editar' },
      update: {},
      create: {
        nome: 'clientes_editar',
        descricao: 'Editar clientes',
        recurso: 'clientes',
        acao: 'editar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'clientes_excluir' },
      update: {},
      create: {
        nome: 'clientes_excluir',
        descricao: 'Excluir clientes',
        recurso: 'clientes',
        acao: 'excluir'
      }
    }),

    // Colaboradores - CRUD completo
    prisma.permissao.upsert({
      where: { nome: 'colaboradores_criar' },
      update: {},
      create: {
        nome: 'colaboradores_criar',
        descricao: 'Criar colaboradores',
        recurso: 'colaboradores',
        acao: 'criar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'colaboradores_ler' },
      update: {},
      create: {
        nome: 'colaboradores_ler',
        descricao: 'Visualizar colaboradores',
        recurso: 'colaboradores',
        acao: 'ler'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'colaboradores_editar' },
      update: {},
      create: {
        nome: 'colaboradores_editar',
        descricao: 'Editar colaboradores',
        recurso: 'colaboradores',
        acao: 'editar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'colaboradores_excluir' },
      update: {},
      create: {
        nome: 'colaboradores_excluir',
        descricao: 'Excluir colaboradores',
        recurso: 'colaboradores',
        acao: 'excluir'
      }
    }),

    // Grupos Hier√°rquicos - CRUD completo
    prisma.permissao.upsert({
      where: { nome: 'grupos_criar' },
      update: {},
      create: {
        nome: 'grupos_criar',
        descricao: 'Criar grupos hier√°rquicos',
        recurso: 'grupos',
        acao: 'criar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'grupos_ler' },
      update: {},
      create: {
        nome: 'grupos_ler',
        descricao: 'Visualizar grupos hier√°rquicos',
        recurso: 'grupos',
        acao: 'ler'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'grupos_editar' },
      update: {},
      create: {
        nome: 'grupos_editar',
        descricao: 'Editar grupos hier√°rquicos',
        recurso: 'grupos',
        acao: 'editar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'grupos_excluir' },
      update: {},
      create: {
        nome: 'grupos_excluir',
        descricao: 'Excluir grupos hier√°rquicos',
        recurso: 'grupos',
        acao: 'excluir'
      }
    }),

    // Perfis - CRUD completo
    prisma.permissao.upsert({
      where: { nome: 'perfis_criar' },
      update: {},
      create: {
        nome: 'perfis_criar',
        descricao: 'Criar perfis',
        recurso: 'perfis',
        acao: 'criar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'perfis_ler' },
      update: {},
      create: {
        nome: 'perfis_ler',
        descricao: 'Visualizar perfis',
        recurso: 'perfis',
        acao: 'ler'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'perfis_editar' },
      update: {},
      create: {
        nome: 'perfis_editar',
        descricao: 'Editar perfis',
        recurso: 'perfis',
        acao: 'editar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'perfis_excluir' },
      update: {},
      create: {
        nome: 'perfis_excluir',
        descricao: 'Excluir perfis',
        recurso: 'perfis',
        acao: 'excluir'
      }
    }),

    // Permiss√µes - CRUD completo
    prisma.permissao.upsert({
      where: { nome: 'permissoes_criar' },
      update: {},
      create: {
        nome: 'permissoes_criar',
        descricao: 'Criar permiss√µes',
        recurso: 'permissoes',
        acao: 'criar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'permissoes_ler' },
      update: {},
      create: {
        nome: 'permissoes_ler',
        descricao: 'Visualizar permiss√µes',
        recurso: 'permissoes',
        acao: 'ler'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'permissoes_editar' },
      update: {},
      create: {
        nome: 'permissoes_editar',
        descricao: 'Editar permiss√µes',
        recurso: 'permissoes',
        acao: 'editar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'permissoes_excluir' },
      update: {},
      create: {
        nome: 'permissoes_excluir',
        descricao: 'Excluir permiss√µes',
        recurso: 'permissoes',
        acao: 'excluir'
      }
    }),

    // Usu√°rios - CRUD completo
    prisma.permissao.upsert({
      where: { nome: 'usuarios_criar' },
      update: {},
      create: {
        nome: 'usuarios_criar',
        descricao: 'Criar usu√°rios',
        recurso: 'usuarios',
        acao: 'criar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'usuarios_ler' },
      update: {},
      create: {
        nome: 'usuarios_ler',
        descricao: 'Visualizar usu√°rios',
        recurso: 'usuarios',
        acao: 'ler'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'usuarios_editar' },
      update: {},
      create: {
        nome: 'usuarios_editar',
        descricao: 'Editar usu√°rios',
        recurso: 'usuarios',
        acao: 'editar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'usuarios_excluir' },
      update: {},
      create: {
        nome: 'usuarios_excluir',
        descricao: 'Excluir usu√°rios',
        recurso: 'usuarios',
        acao: 'excluir'
      }
    }),

    // Ordens de Servi√ßo - CRUD + Aprova√ß√£o + Gerenciamento
    prisma.permissao.upsert({
      where: { nome: 'ordens_servico_criar' },
      update: {},
      create: {
        nome: 'ordens_servico_criar',
        descricao: 'Criar ordens de servi√ßo',
        recurso: 'ordens_servico',
        acao: 'criar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'ordens_servico_ler' },
      update: {},
      create: {
        nome: 'ordens_servico_ler',
        descricao: 'Visualizar ordens de servi√ßo',
        recurso: 'ordens_servico',
        acao: 'ler'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'ordens_servico_editar' },
      update: {},
      create: {
        nome: 'ordens_servico_editar',
        descricao: 'Editar ordens de servi√ßo',
        recurso: 'ordens_servico',
        acao: 'editar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'ordens_servico_excluir' },
      update: {},
      create: {
        nome: 'ordens_servico_excluir',
        descricao: 'Excluir ordens de servi√ßo',
        recurso: 'ordens_servico',
        acao: 'excluir'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'ordens_servico_aprovar' },
      update: {},
      create: {
        nome: 'ordens_servico_aprovar',
        descricao: 'Aprovar ordens de servi√ßo',
        recurso: 'ordens_servico',
        acao: 'aprovar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'ordens_servico_gerenciar' },
      update: {},
      create: {
        nome: 'ordens_servico_gerenciar',
        descricao: 'Gerenciar ordens de servi√ßo',
        recurso: 'ordens_servico',
        acao: 'gerenciar'
      }
    }),

    // Or√ßamentos - CRUD + Aprova√ß√£o + Gera√ß√£o
    prisma.permissao.upsert({
      where: { nome: 'orcamentos_criar' },
      update: {},
      create: {
        nome: 'orcamentos_criar',
        descricao: 'Criar or√ßamentos',
        recurso: 'orcamentos',
        acao: 'criar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'orcamentos_ler' },
      update: {},
      create: {
        nome: 'orcamentos_ler',
        descricao: 'Visualizar or√ßamentos',
        recurso: 'orcamentos',
        acao: 'ler'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'orcamentos_editar' },
      update: {},
      create: {
        nome: 'orcamentos_editar',
        descricao: 'Editar or√ßamentos',
        recurso: 'orcamentos',
        acao: 'editar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'orcamentos_excluir' },
      update: {},
      create: {
        nome: 'orcamentos_excluir',
        descricao: 'Excluir or√ßamentos',
        recurso: 'orcamentos',
        acao: 'excluir'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'orcamentos_aprovar' },
      update: {},
      create: {
        nome: 'orcamentos_aprovar',
        descricao: 'Aprovar or√ßamentos',
        recurso: 'orcamentos',
        acao: 'aprovar'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'orcamentos_gerar' },
      update: {},
      create: {
        nome: 'orcamentos_gerar',
        descricao: 'Gerar or√ßamentos automaticamente',
        recurso: 'orcamentos',
        acao: 'gerar'
      }
    }),

    // Webmail - Permiss√µes espec√≠ficas
    prisma.permissao.upsert({
      where: { nome: 'webmail_email_read' },
      update: {},
      create: {
        nome: 'webmail_email_read',
        descricao: 'Ler emails no webmail',
        recurso: 'webmail',
        acao: 'email_read'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'webmail_email_send' },
      update: {},
      create: {
        nome: 'webmail_email_send',
        descricao: 'Enviar emails no webmail',
        recurso: 'webmail',
        acao: 'email_send'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'webmail_email_delete' },
      update: {},
      create: {
        nome: 'webmail_email_delete',
        descricao: 'Excluir emails no webmail',
        recurso: 'webmail',
        acao: 'email_delete'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'webmail_config_read' },
      update: {},
      create: {
        nome: 'webmail_config_read',
        descricao: 'Visualizar configura√ß√µes do webmail',
        recurso: 'webmail',
        acao: 'config_read'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'webmail_config_write' },
      update: {},
      create: {
        nome: 'webmail_config_write',
        descricao: 'Gerenciar configura√ß√µes do webmail',
        recurso: 'webmail',
        acao: 'config_write'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'webmail_folder_read' },
      update: {},
      create: {
        nome: 'webmail_folder_read',
        descricao: 'Visualizar pastas do webmail',
        recurso: 'webmail',
        acao: 'folder_read'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'webmail_folder_manage' },
      update: {},
      create: {
        nome: 'webmail_folder_manage',
        descricao: 'Gerenciar pastas do webmail',
        recurso: 'webmail',
        acao: 'folder_manage'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'webmail_attachment_upload' },
      update: {},
      create: {
        nome: 'webmail_attachment_upload',
        descricao: 'Fazer upload de anexos no webmail',
        recurso: 'webmail',
        acao: 'attachment_upload'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'webmail_attachment_download' },
      update: {},
      create: {
        nome: 'webmail_attachment_download',
        descricao: 'Fazer download de anexos no webmail',
        recurso: 'webmail',
        acao: 'attachment_download'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'webmail_admin_logs' },
      update: {},
      create: {
        nome: 'webmail_admin_logs',
        descricao: 'Visualizar logs de auditoria do webmail',
        recurso: 'webmail',
        acao: 'admin_logs'
      }
    }),
    prisma.permissao.upsert({
      where: { nome: 'webmail_admin_manage_users' },
      update: {},
      create: {
        nome: 'webmail_admin_manage_users',
        descricao: 'Gerenciar usu√°rios do webmail',
        recurso: 'webmail',
        acao: 'admin_manage_users'
      }
    }),

    // Sistema (admin)
    prisma.permissao.upsert({
      where: { nome: 'sistema_administrar' },
      update: {},
      create: {
        nome: 'sistema_administrar',
        descricao: 'Administrar sistema',
        recurso: 'sistema',
        acao: 'administrar'
      }
    })
  ])

  // Criar perfil administrador
  console.log('üë§ Criando perfil administrador...')
  const perfilAdmin = await prisma.perfil.upsert({
    where: { nome: 'Administrador' },
    update: {},
    create: {
      nome: 'Administrador',
      descricao: 'Acesso total ao sistema',
      ativo: true
    }
  })

  // Associar todas as permiss√µes ao perfil administrador
  console.log('üîó Associando permiss√µes ao perfil administrador...')
  for (const permissao of permissoes) {
    await prisma.perfilPermissao.upsert({
      where: {
        perfilId_permissaoId: {
          perfilId: perfilAdmin.id,
          permissaoId: permissao.id
        }
      },
      update: {},
      create: {
        perfilId: perfilAdmin.id,
        permissaoId: permissao.id
      }
    })
  }

  // Criar grupo hier√°rquico
  console.log('üè¢ Criando grupo hier√°rquico...')
  let grupoAdmin = await prisma.grupoHierarquico.findFirst({
    where: { nome: 'Administra√ß√£o' }
  })
  
  if (!grupoAdmin) {
    grupoAdmin = await prisma.grupoHierarquico.create({
      data: {
        nome: 'Administra√ß√£o',
        descricao: 'Grupo administrativo principal',
        ativo: true
      }
    })
  }

  // Criar colaborador administrador
  console.log('üë®‚Äçüíº Criando colaborador administrador...')
  const colaboradorAdmin = await prisma.colaborador.upsert({
    where: { email: 'admin@garapasystem.com' },
    update: {},
    create: {
      nome: 'Administrador do Sistema',
      email: 'admin@garapasystem.com',
      telefone: '(11) 99999-9999',
      documento: '000.000.000-00',
      cargo: 'Administrador',
      dataAdmissao: new Date(),
      ativo: true,
      perfilId: perfilAdmin.id,
      grupoHierarquicoId: grupoAdmin.id
    }
  })

  // Criar usu√°rio administrador
  console.log('üîê Criando usu√°rio administrador...')
  const senhaHash = await bcrypt.hash('password', 10)
  const usuarioAdmin = await prisma.usuario.upsert({
    where: { email: 'admin@garapasystem.com' },
    update: {},
    create: {
      email: 'admin@garapasystem.com',
      senha: senhaHash,
      nome: 'Administrador do Sistema',
      ativo: true,
      colaboradorId: colaboradorAdmin.id
    }
  })

  // Criar alguns clientes de exemplo
  console.log('üë• Criando clientes de exemplo...')
  await prisma.cliente.upsert({
    where: { email: 'cliente1@exemplo.com' },
    update: {},
    create: {
      nome: 'Jo√£o Silva',
      email: 'cliente1@exemplo.com',
      telefone: '(11) 98888-8888',
      documento: '123.456.789-00',
      tipo: 'PESSOA_FISICA',
      status: 'CLIENTE',
      valorPotencial: 50000,
      grupoHierarquicoId: grupoAdmin.id,
      enderecos: {
        create: {
          logradouro: 'Rua das Flores',
          numero: '123',
          bairro: 'Centro',
          cidade: 'S√£o Paulo',
          estado: 'SP',
          cep: '01234-567',
          tipo: 'RESIDENCIAL',
          principal: true
        }
      }
    }
  })

  await prisma.cliente.upsert({
    where: { email: 'empresa@exemplo.com' },
    update: {},
    create: {
      nome: 'Empresa Exemplo Ltda',
      email: 'empresa@exemplo.com',
      telefone: '(11) 3333-3333',
      documento: '12.345.678/0001-90',
      tipo: 'PESSOA_JURIDICA',
      status: 'PROSPECT',
      valorPotencial: 200000,
      grupoHierarquicoId: grupoAdmin.id,
      enderecos: {
        create: [
          {
            logradouro: 'Av. Paulista',
            numero: '1000',
            bairro: 'Bela Vista',
            cidade: 'S√£o Paulo',
            estado: 'SP',
            cep: '01310-100',
            tipo: 'COMERCIAL',
            principal: true
          },
          {
            logradouro: 'Rua das Entregas',
            numero: '500',
            bairro: 'Vila Madalena',
            cidade: 'S√£o Paulo',
            estado: 'SP',
            cep: '05433-000',
            tipo: 'ENTREGA',
            principal: false
          }
        ]
      }
    }
  })

  // Verificar e criar m√≥dulos do sistema
  console.log('üîß Verificando m√≥dulos do sistema...')
  const modulosCount = await prisma.moduloSistema.count()
  
  if (modulosCount === 0) {
    console.log('üì¶ Criando m√≥dulos do sistema...')
    // Executar o script de seed de m√≥dulos
    const { execSync } = require('child_process')
    try {
      execSync('tsx /app/scripts/seed-modulos.ts', { stdio: 'inherit' })
      console.log('‚úÖ M√≥dulos criados com sucesso!')
    } catch (error) {
      console.error('‚ùå Erro ao criar m√≥dulos:', error)
    }
  } else {
    console.log(`üìä M√≥dulos j√° existem (${modulosCount} encontrados)`)
  }

  console.log('‚úÖ Seed conclu√≠do com sucesso!')
  console.log('üìß Email: admin@garapasystem.com')
  console.log('üîë Senha: password')
}

main()
  .catch((e) => {
    console.error('‚ùå Erro durante o seed:', e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })